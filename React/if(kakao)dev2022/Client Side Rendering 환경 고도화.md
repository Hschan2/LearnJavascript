# 카카오페이 프론트엔드 개발팀의 Client Side Rendering 환경 고도화
Client Side Rendering 환경 개선과 관련되어 <b>공통서버 개선</b>, <b>빠른 배포</b>, <b>빠른 롤백</b>, <b>FE 서비스 PC 배포</b>, <b>Open Graph 운영성 업무</b> 등으로 환경 고도화의 예가 존재한다.   

서비스를 제공하는 서버의 운영이 어려워 환경의 변화를 가져야 하거나 빠른 배포를 원하거나 혹은 새로운 기능을 오픈하기 전에 운영 환경에서 확인하고 싶을 때가 종종 발생한다.   

<b>첫 번째</b>, 공통 기능(인증, SEO, 기타) 사용을 위하 FE 서비스가 공통 서버에 의존하게 되고 서비스 개수가 늘어나고 유입 트래픽의 지속적인 증가가 발생하면서 현재 상황에 맞는 신규 환경 구성이 필요할 때가 있다.   

만약 서버 관리 부담을 줄이기 위해 기존 물리 서버에서 추가로 물리 서버를 늘린다면 신규 서버에 마이그레이션을 하면서 기존 구동 서버와 신규 투입 서버의 버전이 달라질 수 있다. 그래서 이를 방지하여 진행하기 위한 고민이 필요하다.   

큰 틀에서 기존과 동일한 환경 구성에서 진행하고자 할 때, 버전 오류 문제 없이 서버 관리의 부담이 적은 환경을 구축하려면 물리 서버 기반의 공통 서비를 Container 기반 아키텍처로 변경하고 서버 내부에 보관되던 산출물을 별도 공간으로 분리해야 한다.   

즉, 기존과 유사하지만 서버 관리 부담을 덜어낼 수 있는 환경을 만들어야 하며 서비스 개발자에 과도한 마이그레이션 부담을 주지 않는 방식으로 진행해야 한다.   

카카오페이 프론트엔드 팀은 이를 위해서 물리 서버 환경에서 Container 기반의 K8s 환경으로 변경하여 진행하였다. K8s는 <b>Kubernetes</b>로 컨테이너화된 애플리케이션의 관리를 도와주는 오픈소스 시스템으로 점진적 롤아웃을 통한 안정적인 무중단 배포가 가능하다. 그리고 간편한 스케일링을 지원한다.   

애플리케이션을 컨테이너 아키텍처로 변경하고 나서 서버 내부에 보관되던 산출물의 별도 공간을 분리하는 변경 과정을 진행하여 물리 서버 내부에 보관되던 것을 외부의 별도 저장소로 변경하여 배포하는 작업으로 진행하였다.   

이 방법은 배포 설정을 변경하고 나서 재배포만으로 마이그레이션이 완료가 되어 부담이 없다.   

<b>두 번째</b>, 프론트엔드 서비스 배포와 롤백에 오랜 시간이 걸리는 문제가 발생할 수 있다. 특히, 배포 시, 의존성 설치가 생각보다 오래 걸릴 수 있다.   

이를 줄이기 위해서 ```Yarn Berry (Yarn 2)```을 도입하여 해결할 수 있다. 이 방법은 Node JS 환경에서 사용 가능한 패키지 매니저로 Node Module의 Plug N Play를 지원하여 효율적인 의존성 관리와 예측 가능한 의존성 사용, 환경과 독립된 실행 환경을 보장하게 해준다.   

Plug N Play는 패키지를 ```.pnp.jcs``` 파일로 관리되며 패키지 파일은 프로젝트 내 ```Cache``` 폴더에 보관되어 Git으로 관리한다. ```.pnp.jcs```은 ```Cache``` 폴더의 패키지 파일을 참조한다. 이를 통해, ```npm ci```를 통해 Remote Package Repository에 접근하지 않아도 깃의 보괸된 Cache 파일만으로 Node Module들을 사용할 수 있게 된다.   

롤백도 마찬가지로 배포와 비슷한 상황이 발생하여 시간이 오래 걸릴 수 있다. 이를 개선하기 위해 공통 서버가 외부 스토리지에 조회를 할 때, ```symlink```라는 진입점 파일을 구성하여 항상 최신버전을 가리키도록 하여 진행할 수 있다.   

여기서 롤백을 하게 될 시에는 해당 Commit Id의 빌드 산출물이 존재하는지 확인을 하고 만약 존재한다면 해당 산출물로 ```symlink```을 교체한다. 이 후, 사용자는 교체된 파일로 이용하게 된다.   

이러한 방법으로 배포 시간과 롤백 시간이 현저히 줄어들어 <b>업무 효율이 향상</b>이 되고 <b>운영 안정성이 증진</b>될 수 있다.   

<b>세 번째</b>, 오픈 전에 기능 최종적으로 확인하고 싶을 때, 운영 단계에서 

```Release Candidate```와 ```운영```로 나누어 지정된 사용자만 ```Release Candidate```를 이용할 수 있도록 변경해 진행할 수 있다. 지정된 사용자는 인증 값에 의해 결정된다.   

이 과정은 일반 사용자가 아닌 사내 사용자 대상으로 <b>최종 실환경 검증</b> 단계를 거칠 수 있다.   

<b>네 번째</b>, 외부 트래픽을 전이시키기 위해 운영성 개발 업무의 존재를 고민할 필요가 있다. 공유 기능을 사용할 때, 공유 링크로 접속하는 잠재 사용자가 유입할 때는 공유 링크를 왜 클릭해야 하는지 <b>적잘한 URL 미리보기</b>가 제공되어야 한다. 이는 

```Open Graph Protocol(OG Tag)```을 사용을 고려할 필요가 있다. 이를 활용함으로써 소셜 그래프 내에서 웹 페이지를 리치하게 표한할 수 있고 ```<meta> 태그의 Property와 Content```를 사용하여 표현할 수 있다.   

```
// 예시 코드

<head>
    <meta property="og:type" content="website" />
    <meta property="og:title" content="병원서류 발급" />
    <meta property="og:description" content="실비청구할 때 병원 갈 필요없이 병원서류 발급받으세요!" />
    <meta property="og:image" content="https://~/insurance-homme/images/insu-claim-docu-share-fb.png" />
</head>
```

그러나, 이는 ```Client Side Rendering 환경```에서 운영하기 어렵다. 서비스마다 하나의 ```Index.html```가 존재하여 서비스마다 하나의 <b>Open Graph</b>의 정의가 가능하다는 의미가 된다. 그래서 페이지마다 다르게 적용이 필요하다. <b>Open Graph</b>로 최대한 리치한 정보를 제공해야 하는데 이를 해결하기 위해서 경로별 <b>Open Graph</b> 설정이 가능하게 변경해야 한다.   

<b>Open Graph</b>를 포함한 <b>Static HTML 페이지</b>를 만들어서 배포하고 <b>Static HTML 페이지</b>에 사용자가 접속할 시 원래 서비스 페이지로 

```Redirect```하도록 만들 수 있다.   

그러나 이 방법도 필요 할때마다 <b>Static 페이지</b> 생성 작업이 필요하게 된다. 그래서 효율성이 떨어진다. 그래서 이를 개선하기 위해 경로별로 <b>Open Graph</b>를 FE 공통 서버에 주입시키도록 설정하여 진행할 수 있다. 그래서 경로별로 <b>Open Graph</b> 값을 등록할 수 있는 환경이 구축되고 사용자가 요청한 경로에 해당하는 <b>Open Graph</b> 값을 제공할 수 있게 된다.   

## 정리
프론트엔드 환경을 고도화하기 위해서 다음과 같은 방법을 고려할 필요가 있다.   

* 프론트엔드 서비스 제공 환경의 유연한 운영이 어려울 때 = 레거시 환경을 COntainer 기반 K8s 환경으로 이관해 유연한 서버 관리가 가능
* 배포, 롤백에 오랜 시간 소요될 때 = Yarn Berry 도입 및 롤백 전략 수립으로 배표 및 롤백 시간이 대폭 단축 가능
* 퍼블릭 오픈 전 기능 최종 확인 수단의 부재가 있을 때 = 계정 기반의 RC 배포 환경 도입으로 퍼블릭 오픈 전 추가 검증 레이어 확보
* 외부 트래픽을 전이시키기 위한 운영성 개발업무가 존재할 때 = 경로별 Open Graph 관리 시스템 구축으로 유연한 Open Graph 운영 가능   

[Client Side Rendering 환경 고도화](https://if.kakao.com/2022/session/83)